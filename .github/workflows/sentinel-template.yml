# Reusable workflow for Sentinel tests
# This workflow contains shared configuration and steps for both ZTF and Rubin surveys

name: Sentinel Test Template

on:
  workflow_call:
    inputs:
      survey:
        required: true
        type: string
        description: 'Survey name (ztf or rubin)'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest

    container:
      # Warning: use of 'latest' tag is discouraged in production because it can lead to non-reproducible runs,
      # it is used here for simplicity
      image: gitlab-registry.in2p3.fr/astrolabsoftware/fink/fink-deps-sentinel-${{ inputs.survey }}:latest

    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    steps:
    - name: Check env DEBUG
      run: |
        env
    - uses: actions/checkout@v4

    - name: Download simulator
      run: |
        pwd
        git clone https://github.com/astrolabsoftware/fink-alert-simulator.git
    - name: Download schemas
      run: |
        git clone --depth 1 --branch v0.0.2-rc0 https://github.com/astrolabsoftware/fink-alert-schemas.git

        # for the test suite
        cp -r fink-alert-schemas/datasim .
    - name: Set up env
      run: |
        export FINK_HOME=$GITHUB_WORKSPACE
        export FINK_ALERT_SIMULATOR=${FINK_HOME}/fink-alert-simulator/rootfs/fink
        echo "FINK_HOME=$FINK_HOME" >> $GITHUB_ENV
        echo "FINK_ALERT_SIMULATOR=$FINK_ALERT_SIMULATOR" >> $GITHUB_ENV
        echo "FINK_SCHEMA=${FINK_HOME}/fink-alert-schemas" >> $GITHUB_ENV
        echo "PYTHONPATH=${FINK_HOME}:${FINK_ALERT_SIMULATOR}:${PYTHONPATH}" >> $GITHUB_ENV
        # TODO test if needed
        echo "KAFKA_OPTS=-Djava.net.preferIPv4Stack=True" >> $GITHUB_ENV
        echo "${FINK_HOME}/bin:${FINK_ALERT_SIMULATOR}/bin" >> $GITHUB_PATH
    - name: Check env
      run: |
        echo "PATH: $PATH"
        echo "FINK_HOME: $FINK_HOME"
        echo "SPARK_HOME: $SPARK_HOME"
        echo "SPARKLIB: $SPARKLIB"
        echo "FINK_ALERT_SIMULATOR: $FINK_ALERT_SIMULATOR"
        echo "FINK_SCHEMA: $FINK_SCHEMA"
        echo "KAFKA_HOME: $KAFKA_HOME"
        echo "PYTHONPATH: $PYTHONPATH"
        echo "JAVA_HOME: $JAVA_HOME"
        echo `python -V`
    - name: Start services
      run: |
        ${FINK_BROKER_ROOT}/sentinel/start_services.sh
    - name: Run ${{ inputs.survey }} test suite
      run: |
        if [ "${{ inputs.survey }}" = "ztf" ]; then
          fink_test_ztf -c $FINK_HOME/conf/ztf/fink.conf.dev --stream-integration --db-integration --mm-offline --unit-tests
          curl -s https://codecov.io/bash | bash
        elif [ "${{ inputs.survey }}" = "rubin" ]; then
          fink_test_rubin -c $FINK_HOME/conf/rubin/fink.conf.dev --stream-integration --db-integration --unit-tests
        fi
    - uses: actions/upload-artifact@v4
      with:
        name: logs-${{ inputs.survey }}
        path: broker_logs
        retention-days: 7
        overwrite: true
      if: always()
    - uses: act10ns/slack@v1
      with:
        status: ${{ job.status }}
      if: always()
